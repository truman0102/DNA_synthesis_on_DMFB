## Introduction

大规模数字微流控芯片的一个特征是高密度的电极阵列，既可以用于控制液滴的运动，作为布线路径，也可以将反应区灵活地设置在芯片上，通过合理布局来达到降低反应区之间的干扰，减少布线长度以及优化调度的目的。我们首先根据合成需求构建了有向带权图，确定了反应物的入口位置以及反应区之间的连通关系，接着通过模拟退火算法对反应区进行布局，同时控制了反应区的范围和间距。然后我们在考量通量和冲突的前提下，模拟液滴从入口到反应区的一次性运动过程，实现对芯片的布线。最后，我们在逻辑层上对动态的反应过程进行调度，使得反应能够有序进行。

## Problem Statement

在一块规模为$h\times w$的数字微流控芯片上，有$n$个不同的 DNA 合成反应需要进行，对应$n$个反应区$\left\{(\text{zone}_1,\zeta_1), (\text{zone}_2,\zeta_2), \dots, (\text{zone}_n,\zeta_n)\right\}$，其中$\zeta_i$表示需要合成的 DNA 序列。除第一产物$\zeta_1$以外，每个 DNA 序列总是由前序的 DNA 序列的某一点位突变得到，因此可以被组织成一棵突变树的形式，相对应地，反应区也可以随树的深度进行分级。我们的问题是在芯片上合理布局反应区，然后对反应物到达反应区的路径进行布线，最后对反应过程进行调度。

## Placement

在我们设计的微流控芯片上，各种液滴（除中间产物外）的入口$E_i$都是固定在芯片的边界上的，分为完全静态固定和动态固定两种，这种分类方式是根据液滴种类来讨论的。完全静态固定是指非核苷酸液滴的入口，它们的位置是固定的；而 dNTP 和 ddNTP 液滴的两组入口是可动态排序的，这是因为反应区所需要的各类核苷酸数量会随着环境所需产物的序列变化而变化，所以我们理应根据反应区的需求来调整核苷酸液滴的入口顺序。

布局算法的目标是在给定入口坐标$p_E$和反应物需求的情况下，找到一种合理的布局方式，便于后续液滴的路由。因此我们考虑将入口和反应区看作图的节点，将它们之间的液滴流量看作图的加权边，然后构建一个有向图$G_d$，根据这个图来实现入口的动态排序和反应区的布局。具体来说，布局算法的输入包括：

- 变量
  - 入口坐标$p_E$，包括完全静态固定的入口和动态固定的入口
  - 反应需求，可表示为突变树
- 超参数
  - 反应区的范围$\Omega=(x_1,y_1,x_2,y_2)$，限制反应区在芯片的某个区域内，一般是芯片的中心区域
  - 反应区的最小间距$\eta$，限制反应区之间的最小间距，以避免液滴的交叉

有向图$G_d$的构建主要考虑液滴的流动方向和流量大小，按照液滴从入口到反应区或从反应区到反应区的流动方向，我们可以添加相应的有向边，边的权重与液滴的流量成正比。$G_d$中所有作为入口的节点都是只有出度没有入度的根节点，而反应区节点则兼具入度和出度，根据$G_d$的结构特征，我们将布局算法分为两个阶段：

1. 入口排序：在这个阶段，我们只固定非核苷酸液滴的入口，使用力导向布局算法来调整核苷酸液滴的入口顺序，使得动态入口的相对顺序能尽量适宜反应区的需求。
2. 反应区布局：在这个阶段，我们固定所有入口的位置，在指定的范围内使用模拟退火算法来调整反应区的位置，使得反应区之间的距离尽量大、反应区的位置尽量靠近芯片的中心且反应区的分布更加合理。

最终我们得到了一个合理的布局，以及反应区的位置和它们之间的连接关系，这些信息将被用于初始化环境。

## Routing

布线算法使用强化学习模拟液滴从入口到反应区的移动过程，

液滴的观测状态是以液滴为中心的一个局部区域，包括液滴的位置、目标的位置（区域外的目标可以转换为观测值边界的虚拟位置）、周围的环境信息（包括障碍、其他液滴的位置、目标位置等）以及局部区域内各个电极上的通量信息。液滴的动作是在四个方向上的移动，每次移动一个单位距离，液滴的奖励是根据

奖励函数：

- 步数惩罚：每走一步给予微小的惩罚，以鼓励液滴尽快到达目标位置
- 靠近目标奖励：每次靠近目标位置给予奖励，以鼓励液滴朝着目标位置移动
- 到达目标奖励：到达目标位置给予奖励，以鼓励液滴尽快到达目标位置
- 非法移动惩罚：液滴移动到障碍物上导致任务失败，给予较大的惩罚
- 冲突惩罚：液滴与其他种类液滴的移动轨迹相交导致后续调度更加困难，给予一定的惩罚，这个惩罚应当与交叉点的通量正相关
- 重复移动惩罚：液滴采取的移动与上一步相反，没有意义，给予一定的惩罚

## Experiments

### Environment

环境中的元素包括

- 固定位置的入口$E$：可以发送不同种类的液滴，包括核苷酸、一级反应区所需的引物、洗脱液以及用于擦除轨迹的缓冲液
- 反应区$\text{z}$：每个反应区都有唯一目标序列$\zeta$，并且可能有一个或多个突变体，每当某一位点将要发生突变时，将已经合成的前缀序列从反应区中析出，然后送入下一个反应区继续合成。因此突变体的数量与相连通的下级反应区数量对应。
- 可移动的液滴$d$：包括送往各个反应区的核苷酸、只送往一级反应区的引物和洗脱液、在反应区之间传递的中间产物、以及用于擦除轨迹的缓冲液，其中只有缓冲液不会进入反应区。
- 布线路径$P$：记录液滴的运动轨迹，包括从入口到反应区的路径以及反应区之间的路径。既要记录每个液滴实例的轨迹

布线时我们需要考虑的是液滴的流通量，以及不同种类液滴之间的冲突，但不需要考虑反应的顺序，因为反应顺序是在布线后的调度阶段进行的。每个 step 我们首先要选择一个优先度高的液滴来移动，然后获取这个液滴的当前时刻的观测状态，包括当前的位置、目标位置、以及周围的环境信息，然后根据这些信息来选择下一步的动作，最后更新环境状态，获得移动后的状态和奖励。

液滴的优先级主要与以下几个因素有关：

- 液滴的流量：流量大的液滴优先级高
- 液滴的位置
  - 距离目标位置的距离：距离目标位置越近，优先级越高
  - 与其他液滴的冲突：与其他液滴的冲突越多，优先级越高
- 液滴的种类：不同种类的液滴有不同的优先级
  - 核苷酸液滴：优先级最高，因为它们是反应的基本组成部分
  - 洗脱液：优先级次之，因为它是前往下一个反应区的必要条件
  - 引物液滴：优先级次之，因为它们是反应的前导物
  - 琼脂糖：优先级最低，因为它们不参与反应
- 液滴的状态：已经到达目标位置的液滴优先级最低，不需要移动

### Results

### Abalation Study
