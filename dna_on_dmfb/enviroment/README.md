## Introduction

大规模数字微流控芯片的一个特征是高密度的电极阵列，既可以用于控制液滴的运动，作为布线路径，也可以将反应区灵活地设置在芯片上，通过合理布局来达到降低反应区之间的干扰，减少布线长度以及优化调度的目的。我们首先根据合成需求构建了有向带权图，确定了反应物的入口位置以及反应区之间的连通关系，接着通过模拟退火算法对反应区进行布局，同时控制了反应区的范围和间距。然后我们在考量通量和冲突的前提下，模拟液滴从入口到反应区的一次性运动过程，实现对芯片的布线。最后，我们在逻辑层上对动态的反应过程进行调度，使得反应能够有序进行。

## Problem Statement

在一块规模为$h\times w$的数字微流控芯片上，有$n$个不同的 DNA 合成反应需要进行，对应$n$个反应区$\left\{(\text{zone}_1,\zeta_1), (\text{zone}_2,\zeta_2), \dots, (\text{zone}_n,\zeta_n)\right\}$，其中$\zeta_i$表示需要合成的 DNA 序列。除第一产物$\zeta_1$以外，每个 DNA 序列总是由前序的 DNA 序列的某一点位突变得到，因此可以被组织成一棵突变树的形式，相对应地，反应区也可以随树的深度进行分级。我们的问题是在芯片上合理布局反应区，然后对反应物到达反应区的路径进行布线，最后对反应过程进行调度。

## Placement

在我们设计的微流控芯片上，各种液滴（除中间产物外）的入口$E_i$都是固定在芯片的边界上的，分为完全静态固定和动态固定两种，这种分类方式是根据液滴种类来讨论的。完全静态固定是指非核苷酸液滴的入口，它们的位置是固定的；而 dNTP 和 ddNTP 液滴的两组入口是可动态排序的，这是因为反应区所需要的各类核苷酸数量会随着环境所需产物的序列变化而变化，所以我们理应根据反应区的需求来调整核苷酸液滴的入口顺序。

布局算法的目标是在给定入口坐标$p_E$和反应物需求的情况下，找到一种合理的布局方式，便于后续液滴的路由。因此我们考虑将入口和反应区看作图的节点，将它们之间的液滴流量看作图的加权边，然后构建一个有向图$G_d$，根据这个图来实现入口的动态排序和反应区的布局。具体来说，布局算法的输入包括：

- 变量
  - 入口坐标$p_E$，包括完全静态固定的入口和动态固定的入口
  - 反应需求，可表示为突变树
- 超参数
  - 反应区的范围$\Omega=(x_1,y_1,x_2,y_2)$，限制反应区在芯片的某个区域内，一般是芯片的中心区域
  - 反应区的最小间距$\eta$，限制反应区之间的最小间距，以避免液滴的交叉

有向图$G_d$的构建主要考虑了液滴的流动方向和流量大小，按照液滴从入口到反应区或从反应区到反应区的流动方向，我们可以添加相应的有向边，边的权重与液滴的流量成正比。$G_d$中所有作为入口的节点都是只有出度没有入度的根节点，而反应区节点则兼具入度和出度，根据$G_d$的结构特征，我们将布局算法分为两个阶段：

1. 入口排序：在这个阶段，我们只固定非核苷酸液滴的入口，使用力导向布局算法来调整核苷酸液滴的入口顺序，使得动态入口的相对顺序能尽量适宜反应区的需求。力导向布局根据边的权重模拟力的作用，能够模拟出在给定的反应区需求下，各个入口的相对位置。
2. 反应区布局：在这个阶段，我们固定所有入口的位置，在指定的范围内使用模拟退火算法来调整反应区的位置，使得反应区之间的距离尽量大、反应区的位置尽量靠近芯片的中心且反应区的分布更加合理。

最终我们得到了一个合理的布局，以及反应区的位置和它们之间的连接关系，这些信息将被用于初始化环境。

## Routing

布线算法使用强化学习模拟液滴从入口到反应区的移动过程，具体来说我们使用了 DQN 算法来学习在给定局部区域状态时不同动作的 $Q$值，然后根据 $Q$ 值来选择最优的动作。我们设计了随机序列的生成，用来模拟不同通量和布局的合成环境，采用经验回放的方式来收集大量的离线数据，用于提高 DQN 的泛化性能，并加速收敛。在每个时间步，我们根据优先级规则来选择一个尚未到达反应区的液滴，根据$\epsilon$-贪心策略来选择动作，然后根据环境的反馈来更新 $Q$ 值，~~在动作探索时，我们鼓励 agent 从合法动作中选择，因为非法动作会导致任务的失败和较大的惩罚~~。观测状态和奖励函数的构成可以参加[环境](#environment)部分的描述。

我们发现在探索时，agent 经常会选择违法动作，导致任务失败，这可能是因为违法动作在每一集中最多出现一次导致的离线数据中负样本的不足，因此我们设计了一种只探索正样本+对比负样本的方式来训练 DQN，这样既不用显式地向经验回放池中添加违法动作，也能够保证 agent 在训练过程中能够学习到违法动作的惩罚，节省了人工成本。具体来说，我们选用了一种负对数对比损失函数：

$$
\begin{aligned}
\mathcal{L}_{\text{contrast}} &= -\log\left(\frac{\sum_{a^+\in\mathcal{A}^+}e^{Q(s,a^+)}}{\sum_{a^+\in\mathcal{A}^+}e^{Q(s,a^+)}+\sum_{a^-\in\mathcal{A}^-}e^{Q(s,a^-)}}\right)\\
\end{aligned}
$$

## Scheduling

在布线阶段，我们已经得到了每个液滴的合理移动轨迹，然后我们需要按照反应发生的实际顺序来调度液滴的移动。一个真实的合成反应总是从一级反应区开始，向反应区发送引物和核苷酸，核苷酸在反应区内依次合成 DNA 序列。当一个反应区内合成突变前缀序列时，一部分的前缀序列会被析出，然后送入下一个反应区继续合成，而另一些前缀序列则会被保留下来，等待下一个核苷酸的到来，直到合成完整的 DNA 序列。当 DNA 合成至最后一位时，送往反应区的核苷酸将由 dNTP 变为不再连接下一位的 ddNTP，最后发送琼脂糖到反应区，将反应区内的 DNA 序列固定在琼脂糖上。

液滴的调度是在布线后的一个阶段，我们需要考虑液滴之间的冲突，以及液滴的优先级。首先，调度的第一标准是保证液滴的合法移动，在不能出界和进入其他目标区域的基础上，还要保证沿着布线轨迹移动并保证移动是满足流体约束的，即保证液滴之间的间距。

一个最简单的情况是液滴按轨迹移动一步时并没有与其他液滴冲突，这种情况无需考虑调度。一个稍微复杂的情况是液滴的下一步位置的电极在其他液滴的移动轨迹上，这时就需要缓冲液滴途径没有被液滴占据的空白路径来对这个位置进行清洗，然后待缓冲液离开后再进行移动。另一种情况是同种液滴挡住了后面的液滴，这时需要等待前面的液滴离开才能继续前进，这与调度的优先级和维持液滴间距有关。最复杂的情况是不同种液滴之间的冲突，类似十字路口的交通规则，我们需要根据液滴的通量和交叉位置附近的情况来决定哪个液滴有优先权，并且在一种液滴移动后仍需缓冲液来清洗轨迹，才能允许另一种液滴继续通过。

## Experiments

### Environment

在模拟布线时，环境中的元素包括

- 固定位置的入口$E$：可以发送不同种类的液滴，包括核苷酸、一级反应区所需的引物、洗脱液以及用于擦除轨迹的缓冲液
- 反应区$\text{z}$：每个反应区都有唯一目标序列$\zeta$，并且可能有一个或多个突变体，每当某一位点将要发生突变时，将已经合成的前缀序列从反应区中析出，然后送入下一个反应区继续合成。因此突变体的数量与相连通的下级反应区数量对应。
- 可移动的液滴$d$：包括送往各个反应区的核苷酸、只送往一级反应区的引物和洗脱液、在反应区之间传递的中间产物、以及用于擦除轨迹的缓冲液，其中只有缓冲液不会进入反应区。
- 布线路径$P$：记录液滴的运动轨迹，包括从入口到反应区的路径以及反应区之间的路径。既要记录每个液滴实例的轨迹

相比于液滴的发送顺序，布线阶段我们考虑更多的是液滴的流通量，以及不同种类液滴之间的冲突，对于反应顺序的处理是在布线后的调度阶段进行的。一个基础的环境应该具备以下功能：

- 初始化 (reset): 初始化环境，包括入口、反应区、液滴的位置和目标位置
- 执行 (step): 执行一个 step，包括选择一个优先度高（靠近目标区域或通量高）的液滴来移动，首先获取这个液滴的当前时刻的观测状态，然后执行一个动作，更新环境的状态，获得新的观测状态和奖励，并返回这些信息
- 奖励 (reward): 根据液滴的移动情况给予奖励，奖励函数包括步数惩罚、靠近目标奖励、到达目标奖励、非法移动惩罚、冲突惩罚和重复移动惩罚
- 观测 (observation): 返回液滴的观测状态，在一个以液滴为中心的局部区域内记录
  - 液滴的位置
  - 目标的位置，如果在区域外，可以转换为观测值边界的虚拟位置
  - 局部区域内同种类液滴的位置和目标位置，以及他们的轨迹信息
  - 局部区域内其他种类液滴的位置和目标位置，以及他们的轨迹信息
  - 局部区域内的障碍物位置，主要是反应区的位置和边界
  - 局部区域内各个电极上的通量信息
- 可视化 (render): 可视化环境的状态，包括入口、反应区、液滴的位置和目标位置，以及布线路径

相较于简单的单液滴路由，我们的环境具备多液滴、高通量、多种类以及多目标的特点，因此液滴在移动过程中会产生更多的冲突，需要更多的考虑。在实际的实验中，我们设计了多种奖励函数来评估移动的好坏，包括：

- 步数惩罚：每一步都会有一个固定的惩罚，以鼓励液滴尽快到达目标，$r_{\text{step}}=-0.1$
- 迂回惩罚：如果液滴在移动过程中出现了走回头路的情况，那么会导致步数的增加，并且这种迂回措施在静态布线中是没有必要的，$r_{\text{retrace}}=-0.2$
- 冲突惩罚：如果液滴移动到了其他种类液滴的轨迹上，那么会造成轨迹的交叉，在调度过程可能会造成拥塞，并且液滴的通量越高，冲突的惩罚也会越高，我们使用一个$\tanh$函数来将冲突的惩罚限制在一个合理的范围内，$r_{\text{conflict}}=-\tanh(f_{\text{sum}}/f_{\text{max}}+0.2)$，其中$f_{\text{sum}}$是冲突点位上所有液滴的通量之和，$f_{\text{max}}$是所有液滴的最大通量，起到了归一化的作用。
- 靠近目标奖励：如果液滴在移动过程中靠近了目标，那么不会给予惩罚，如果移动后（曼哈顿）距离不变，那么给予的惩罚与步数惩罚相同，否则远离目标时给予更大的惩罚，$r_{\text{away}}=-0.3$
- 违法移动惩罚：如果液滴移动到了其他反应区内导致了反应区的污染或是走出边界，那么会给予一个较大的惩罚，$r_{\text{illegal}}=-10$
- 到达目标奖励：如果液滴到达了目标，那么会给予一个较大的奖励，$r_{\text{goal}}=10$
- 成功到达目标奖励：如果所有液滴都到达了目标，那么会给予一个较大的奖励，$r_{\text{success}}=100$

在模拟调度时，环境中的元素应该额外包含每个液滴的轨迹/通道信息，不再需要考虑奖励函数。调度实现的前提是布线已经完成，布线过程应该调用习得的 DQN 模型来模拟液滴的一次性移动过程，获得每种液滴到达目标的通路，然后在调度阶段，每种液滴都按照这个通路来移动，直到所有液滴都到达目标。

调度过程的液滴移动顺序与布线是不同的，因为调度过程必须模拟实际的合成顺序，所以反应总是从一级反应区开始，中间产物只有在前序反应区合成完毕后才会出现，每个时刻环境中存在的液滴数量会远低于布线过程。因此，我们首先应当维护一个可移动液滴队列，然后在每个时间步中，选择一个优先级最高的液滴来移动，直到所有液滴都到达目标。

对于每个液滴而言，我们都要为其维护一个实时的障碍图，来判断液滴是否可以沿着轨迹移动，障碍图首先包括所有的非目标反应区和边界，这是静态的，然后在每个时间步中，我们还要将所有液滴的位置加入到障碍图中，这是动态的，为了满足流体约束，我们还要维护液滴间的距离，这实际上相当于将每个液滴向外扩张一圈。最后还要把所有其他种类的液滴的移动历史加入到障碍图中，如果液滴的下一步位点已经被其他液滴经过并且没有被清洗，那么必须等待缓冲液的到来，否则会导致污染。一个等待缓冲液的液滴需要被标记为等待状态，直到缓冲液到达，然后再被重新加入到可移动液滴队列中。

对于每个液滴和每类液滴，都必须维护一个历史轨迹，这个轨迹记录了哪些电极上存在残留，这个历史轨迹会在缓冲液经过后被清除，所以最后呈现出来的历史轨迹是不连续的。

### Results

评价指标包括：

- 成功率：所有液滴都成功到达目标的比例
- 平均奖励
- 平均损失
- 步数
- 布线长度
- $\dots$

### Abalation Study

- 动态布局 vs 静态布局 or 随机布局
- 考虑冲突 vs 不考虑冲突
- 反应区依次合成 vs 同时合成
